name: terraform-hygiene

on:
  pull_request:
    paths:
      - "infra/gcp/**"
      - ".github/workflows/terraform-hygiene.yml"
  push:
    branches: ["main"]
    paths:
      - "infra/gcp/**"
      - ".github/workflows/terraform-hygiene.yml"

jobs:
  hygiene:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TF_DIR: infra/gcp/cloud_run_demo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"

      - name: Terraform fmt (check)
        run: terraform -chdir=${TF_DIR} fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=${TF_DIR} init -backend=false

      - name: Terraform validate
        run: terraform -chdir=${TF_DIR} validate

      - name: tflint (docker)
        run: |
          docker run --rm -v "${{ github.workspace }}/${TF_DIR}:/workspace" -w /workspace ghcr.io/terraform-linters/tflint:latest --init
          docker run --rm -v "${{ github.workspace }}/${TF_DIR}:/workspace" -w /workspace ghcr.io/terraform-linters/tflint:latest

      - name: tfsec (docker)
        run: docker run --rm -v "${{ github.workspace }}:/src" aquasec/tfsec:latest /src/${TF_DIR}

      - name: checkov (docker)
        run: docker run --rm -v "${{ github.workspace }}:/src" bridgecrew/checkov:latest -d /src/${TF_DIR}

      - name: conftest policy (docker)
        run: docker run --rm -v "${{ github.workspace }}:/project" -w /project openpolicyagent/conftest:latest test --parser hcl2 --policy infra/gcp/policy ${TF_DIR}
