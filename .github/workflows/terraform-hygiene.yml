name: terraform-hygiene

on:
  pull_request:
    paths:
      - "infra/gcp/**"
      - ".github/workflows/terraform-hygiene.yml"
  push:
    branches: ["main"]
    paths:
      - "infra/gcp/**"
      - ".github/workflows/terraform-hygiene.yml"

jobs:
  hygiene:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TF_DIR: infra/gcp/cloud_run_demo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.4"

      - name: Terraform fmt (check)
        run: terraform -chdir=${TF_DIR} fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=${TF_DIR} init -backend=false

      - name: Terraform validate
        run: terraform -chdir=${TF_DIR} validate

      - name: tflint (docker)
        run: |
          docker run --rm -v "${{ github.workspace }}:/repo" -w "/repo/${TF_DIR}" ghcr.io/terraform-linters/tflint:latest --init
          docker run --rm -v "${{ github.workspace }}:/repo" -w "/repo/${TF_DIR}" ghcr.io/terraform-linters/tflint:latest

      - name: tfsec (docker)
        run: docker run --rm -v "${{ github.workspace }}:/src" aquasec/tfsec:latest /src/${TF_DIR}

      - name: checkov (docker)
        run: |
          # NOTE: These skipped checks are org-policy dependent and are intentionally out of scope for
          # this public Cloud Run demo stack (cost + complexity tradeoffs).
          #
          # - CKV_GCP_84: Artifact Registry CMEK/CSEK enforcement (demo uses Google-managed encryption)
          # - CKV_GCP_26: VPC Flow Logs for every subnet (network module is optional; default is no VPC)
          # - CKV2_GCP_18: Require explicit firewall rules (network module is optional; default is no VPC)
          docker run --rm -v "${{ github.workspace }}:/src" bridgecrew/checkov:latest \
            -d "/src/${TF_DIR}" \
            --skip-check "CKV_GCP_84,CKV_GCP_26,CKV2_GCP_18"

      - name: conftest policy (docker)
        run: |
          set -euo pipefail
          # Pass explicit *.tf files so we don't accidentally parse .terraform/** artifacts.
          docker run --rm -v "${{ github.workspace }}:/project" -w /project openpolicyagent/conftest:latest test \
            --parser hcl2 \
            --policy infra/gcp/policy \
            $(find "${TF_DIR}" -type f -name "*.tf" -not -path "${TF_DIR}/.terraform/*")
